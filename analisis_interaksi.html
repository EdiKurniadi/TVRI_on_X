<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisis Interaksi ‚Äî TVRI on ùïè</title>
  
  <!-- ===== App Shell CSS (selaras dengan contoh) ===== -->
  <style>
    :root{
      --sb-bg:#ffffff; --sb-border:#e2e8f0; --sb-ink:#0f172a; --sb-muted:#64748b;
      --sb-accent:#2563eb; --sb-accent-ink:#ffffff; --sb-shadow:0 1px 2px rgba(15,23,42,.06);
      --bg:#f8fafc; --ink:#0f172a; --muted:#475569; --border:#e2e8f0; --accent:#2563eb; --accent-ink:#ffffff;
      --chip:#eef2ff; --chip-ink:#3730a3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans",sans-serif}

    .app-shell{display:grid;grid-template-columns:280px 1fr;min-height:100dvh}
    .app-shell.collapsed{grid-template-columns:100px 1fr}
    .app-sidebar{position:sticky;top:0;height:100dvh;padding:12px}
    .sb-card{height:100%;background:var(--sb-bg);border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);display:flex;flex-direction:column}
    .sb-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--sb-border)}
    .sb-title{font-weight:800}
    .sb-toggle{cursor:pointer;border:1px solid var(--sb-border);background:#fff;border-radius:10px;padding:8px}
    .sb-nav{padding:12px;display:grid;gap:8px;overflow:auto}
    .sb-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--sb-border);border-radius:12px;background:#fff;color:var(--sb-ink);text-decoration:none;font-weight:600}
    .sb-link:hover{border-color:#cbd5e1}
    .sb-link.active{background:var(--sb-accent);border-color:transparent;color:var(--sb-accent-ink)}
    .sb-ico{width:22px;height:22px;display:inline-grid;place-items:center}
    .sb-ico svg{width:20px;height:20px}
    .sb-label{white-space:nowrap}
    .sb-help{margin-top:auto;padding:12px;border-top:1px dashed var(--sb-border);font-size:13px;color:var(--sb-muted)}
    .app-shell.collapsed .sb-title,.app-shell.collapsed .sb-label,.app-shell.collapsed .sb-help{display:none}
    .app-shell.collapsed .sb-head{justify-content:center}

    .app-main{padding:20px}
    .app-card{background:#fff;border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);padding:16px}

    /* ===== Toolbar + Graph area ===== */
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
    .group{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);padding:8px;border-radius:12px}
    .badge{background:#fff;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted)}
    input[type="text"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;min-width:220px}
    input[type="range"]{accent-color:var(--accent)}
    button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    #status{color:var(--muted);margin:8px 0}
    #cy{width:100%;height:calc(100vh - 220px);border:1px solid var(--border);border-radius:14px}
  </style>

  <!-- ===== Library untuk graf ===== -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/layout-base@2.0.1/layout-base.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cose-base@2.2.0/cose-base.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose@2.2.0/cytoscape-fcose.min.js"></script>
</head>
<body>
  <div id="APP" class="app-shell">
    <!-- ===== SIDEBAR ===== -->
    <aside class="app-sidebar" aria-label="Navigasi Layanan">
      <div class="sb-card">
        <div class="sb-head">
          <div class="sb-title">TVRI on <span class="x">ùïè</span></div>
          <button id="sbToggle" class="sb-toggle" title="Sembunyikan/Expand sidebar" aria-expanded="true">‚ü®‚ü©</button>
        </div>
        <nav class="sb-nav">
          <a class="sb-link" href="index.html" title="Data Viewer"><span class="sb-ico">{#icon-doc#}</span><span class="sb-label">Data Viewer</span></a>
          <a class="sb-link" href="distribusi_nilai.html" title="Distribusi Nilai"><span class="sb-ico">{#icon-chart#}</span><span class="sb-label">Distribusi Nilai</span></a>
          <a class="sb-link" href="persilangan_nilai.html" title="Persilangan Nilai"><span class="sb-ico">{#icon-grid#}</span><span class="sb-label">Persilangan Nilai</span></a>
          <a class="sb-link" href="timeline_distribusi.html" title="Analisis Timeline"><span class="sb-ico">{#icon-trend#}</span><span class="sb-label">Analisis Timeline</span></a>
          <a class="sb-link" href="analisis_interaksi.html" title="Analisis Interaksi"><span class="sb-ico">{#icon-network#}</span><span class="sb-label">Analisis Interaksi</span></a>
        </nav>
        <div class="sb-help">Sumber data: <code>data/all.csv</code></div>
      </div>
    </aside>

    <!-- ===== KONTEN ===== -->
    <main class="app-main">
      <div class="app-card">
        <div class="toolbar">
          <span class="badge">Graf: <b>Relasi @mention</b></span>
          <div class="group">
            <label for="search">Fokus akun</label>
            <input id="search" type="text" placeholder="contoh: tvri atau @tvri" />
            <button id="btnFocus" class="primary">Tampilkan Subgraf</button>
            <button id="btnReset">Tampilkan Semua</button>
          </div>
          <div class="group">
            <label for="minWeight">Min interaksi</label>
            <input id="minWeight" type="range" min="1" max="10" step="1" value="1" />
            <span id="minWeightVal" class="badge">‚â• 1</span>
          </div>
          <div class="group" style="margin-left:auto">
            <button id="btnFit">Fit</button>
            <button id="btnPng">Unduh PNG</button>
            <button id="btnReload">Muat ulang</button>
          </div>
        </div>
        <div id="status">Memuat <code>data/all.csv</code>‚Ä¶ Kolom minimal: <code>user_screen_name</code> dan salah satu: <code>text</code> | <code>full_text</code> | <code>tweet_text</code>.</div>
        <div id="cy" role="img" aria-label="Graf relasi akun berdasarkan mention"></div>
      </div>
    </main>
  </div>

  <!-- ===== Ikon + Script shell ===== -->
  <script>
    const ICONS = {
      chart:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="7" rx="1"/><rect x="12" y="6" width="3" height="11" rx="1"/><rect x="17" y="12" width="3" height="5" rx="1"/></svg>`,
      grid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>`,
      trend:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 7-7"/><path d="M21 21H3"/></svg>`,
      doc:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8M8 17h6M8 9h3"/></svg>`,
      network: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"> <circle cx="12" cy="12" r="2"/> <circle cx="4"  cy="12" r="2"/> <circle cx="12" cy="4"  r="2"/> <circle cx="20" cy="12" r="2"/> <circle cx="12" cy="20" r="2"/> <line x1="6"  y1="12" x2="10" y2="12"/> <line x1="12" y1="6"  x2="12" y2="10"/> <line x1="14" y1="12" x2="18" y2="12"/> <line x1="12" y1="14" x2="12" y2="18"/> </svg>`,
    };
    document.querySelectorAll('.sb-ico').forEach(el=>{
      const html = el.innerHTML; const key = /\{#icon-([a-z]+)#\}/.exec(html);
      if(key && ICONS[key[1]]) el.innerHTML = ICONS[key[1]]; else el.innerHTML = ICONS.doc;
    });

    const APP = document.getElementById('APP');
    const SB_TOGGLE = document.getElementById('sbToggle');
    function applySBState(){ const collapsed = localStorage.getItem('sb-collapsed') === '1'; APP.classList.toggle('collapsed', collapsed); SB_TOGGLE.setAttribute('aria-expanded', collapsed ? 'false' : 'true'); }
    SB_TOGGLE.addEventListener('click',()=>{ const next = !(localStorage.getItem('sb-collapsed') === '1'); localStorage.setItem('sb-collapsed', next ? '1' : '0'); applySBState(); });
    applySBState();

    // Auto-active current link
    (function autoActive(){ const path = location.pathname.split('/').pop(); document.querySelectorAll('.sb-link').forEach(a=>{ const fname = (a.getAttribute('href')||'').split('/').pop(); if(fname && fname===path) a.classList.add('active'); }); })();
  </script>

  <!-- ===== Graf logic (autoload data/all.csv + subgraf fokus) ===== -->
  <script>
    try{ if(window.cytoscapeFcose){ cytoscape.use(window.cytoscapeFcose); } }catch(_){}

    const setStatus = (msg) => { document.getElementById('status').textContent = msg }
    const norm = (s) => (s||'').toString().trim();

    function extractMentions(text){
      const out = new Set();
      const re = /(^|[^A-Za-z0-9_@])@([A-Za-z0-9_]{1,15})\b/g;
      let m; const t = text || '';
      while((m = re.exec(t)) !== null){ out.add(m[2]); }
      return Array.from(out);
    }

    let cy; let allElements = [];

    async function loadCSV(path='data/all.csv'){
      setStatus(`Memuat ${path} ‚Ä¶`);
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok){ setStatus(`Gagal memuat ${path}: ${res.status} ${res.statusText}. Pastikan folder \"data\" sejajar & domain sama (GitHub Pages).`); return null; }
      const text = await res.text();
      return new Promise((resolve)=>{ Papa.parse(text, { header:true, skipEmptyLines:true, dynamicTyping:false, complete: (out)=> resolve(out.data) }); });
    }

    function buildGraph(rows){
      const nodesSet = new Set();
      const edgesMap = new Map();
      for(const r of rows){
        const author = norm(r.user_screen_name) || norm(r.user_name) || '';
        const text = r.text || r.full_text || r.tweet_text || '';
        if(!author && !text) continue;
        const mentions = extractMentions(text);
        if(author) nodesSet.add(author);
        for(const m of mentions){
          const target = '@' + m;
          nodesSet.add(target);
          if(!author) continue;
          if(author.toLowerCase() === target.toLowerCase()) continue;
          const key = `${author}‚Üí${target}`;
          edgesMap.set(key, (edgesMap.get(key)||0) + 1);
        }
      }
      const nodes = Array.from(nodesSet).map(u => ({ data:{ id:u, label:u } }));
      const edges = Array.from(edgesMap.entries()).map(([key,w])=>{ const [src,dst] = key.split('‚Üí'); return { data:{ id:`${src}__${dst}`, source:src, target:dst, weight:w } }; });
      allElements = [...nodes, ...edges];
    }

    function renderGraph(elems = allElements){
      if(cy){ cy.destroy(); cy=null }
      let layoutName = 'fcose'; if(!(cytoscape.prototype.fcose || (window.cytoscapeFcose))){ layoutName = 'cose'; }
      cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elems,
        layout: layoutName === 'fcose' ? { name:'fcose', animate:false, randomize:true, nodeSeparation:80 } : { name:'cose', animate:false, nodeRepulsion: 2048 },
        wheelSensitivity: 0.2,
        style: [
          { selector:'node', style:{ 'background-color':'#a7f3d0','label':'data(label)','font-size': 10,'text-valign':'center','text-halign':'center','text-wrap':'wrap','text-max-width': 120,'color':'#0f172a','border-color':'#10b981','border-width':1,'width': 'mapData(degree, 0, 40, 10, 44)','height':'mapData(degree, 0, 40, 10, 44)' }},
          { selector:'edge', style:{ 'width': 'mapData(weight, 1, 10, 1, 8)','line-color':'#64748b','curve-style':'bezier','target-arrow-shape':'triangle','target-arrow-color':'#64748b','arrow-scale':1.2,'opacity':0.85 }}
        ]
      });
      cy.ready(() => setStatus(`Graf siap ‚Äî ${cy.nodes().length} akun, ${cy.edges().length} relasi.`));
      cy.on('tap', 'node', (evt)=> focusSubgraphByNode(evt.target));
    }

    function findNodeByQuery(q){
      if(!cy) return null; const qq = q.toLowerCase();
      const candidates = cy.nodes().filter(n=>{ const id=(n.id()||'').toLowerCase(); const label=(n.data('label')||'').toLowerCase(); return id === qq || id === '@'+qq || label === qq || label === '@'+qq || id.includes(qq) || label.includes(qq); });
      return candidates[0] || null;
    }

    function focusSubgraphByNode(node){
      if(!node) return; const nb = node.closedNeighborhood(); const subElems = nb.union(node); const elems = subElems.jsons(); renderGraph(elems); setStatus(`Subgraf untuk: ${node.data('label')} ‚Äî akun: ${cy.nodes().length}, relasi: ${cy.edges().length}`);
    }
    function focusSubgraphByQuery(q){ const node = findNodeByQuery(q); if(node){ focusSubgraphByNode(node); } else { setStatus(`Akun "${q}" tidak ditemukan pada graf.`); } }
    function resetGraph(){ renderGraph(allElements); applyMinWeightFilter(parseInt(document.getElementById('minWeight').value,10)); }

    function applyMinWeightFilter(minW){
      if(!cy) return; cy.edges().style('display','element'); cy.edges().forEach(e=>{ if((e.data('weight')||0) < minW) e.style('display','none'); });
      cy.nodes().forEach(n=>{ const visibleDeg = n.connectedEdges().filter(e=>e.style('display') !== 'none').length; n.style('display', visibleDeg>0 ? 'element' : 'none'); });
      setStatus(`Filter (‚â• ${minW}) ‚Äî ${cy.nodes(':visible').length} akun, ${cy.edges(':visible').length} relasi.`)
    }

    async function init(){
      try{
        const rows = await loadCSV('data/all.csv'); if(!rows){ return }
        const hasUser = rows.some(r => 'user_screen_name' in r || 'user_name' in r);
        const hasText = rows.some(r => 'text' in r || 'full_text' in r || 'tweet_text' in r);
        if(!hasUser || !hasText){ setStatus('Kolom wajib tidak lengkap. Minimal: user_screen_name (atau user_name), dan salah satu: text | full_text | tweet_text'); return; }
        buildGraph(rows); renderGraph(); applyMinWeightFilter(parseInt(document.getElementById('minWeight').value,10));
      }catch(e){ console.error(e); setStatus('Terjadi kesalahan saat memuat atau memproses data. Lihat konsol.'); }
    }

    document.getElementById('btnFocus').addEventListener('click', ()=>{ const q = norm(document.getElementById('search').value); if(!q){ setStatus('Masukkan nama akun untuk fokus, contoh: tvri atau @tvri'); return; } focusSubgraphByQuery(q); });
    document.getElementById('btnReset').addEventListener('click', resetGraph);
    document.getElementById('btnFit').addEventListener('click', ()=> cy && cy.fit(cy.elements(), 60));
    document.getElementById('btnPng').addEventListener('click', ()=>{ if(!cy) return; const png = cy.png({ full:true, maxWidth:4096, maxHeight:4096, scale:2 }); const a = document.createElement('a'); a.href = png; a.download = 'analisis-interaksi.png'; a.click(); });
    document.getElementById('btnReload').addEventListener('click', init);

    document.getElementById('minWeight').addEventListener('input', (e)=>{ document.getElementById('minWeightVal').textContent = `‚â• ${e.target.value}`; applyMinWeightFilter(parseInt(e.target.value,10)); });

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
