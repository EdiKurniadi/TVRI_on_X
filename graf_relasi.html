<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Graf Relasi Akun — TVRI on X</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#2563eb;
      --chip:#f1f5f9; --chip-ink:#0f172a; --warning:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; color:var(--ink); background:var(--bg)}
    header{display:flex;align-items:center;gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky;top:0;background:var(--bg);z-index:10}
    header h1{font-size:16px;margin:0}
    header .badge{background:var(--chip);color:var(--chip-ink);padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px; align-items:center;}
    .toolbar label{font-weight:600;color:var(--muted)}
    .toolbar .group{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);padding:8px;border-radius:12px}
    input[type="text"], select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;min-width:200px}
    input[type="range"]{accent-color:var(--accent)}
    button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}

    #status{padding:8px 16px;color:var(--muted)}
    #cy{width:100%; height: calc(100vh - 120px);}
    .legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:8px 16px;color:var(--muted);border-top:1px solid var(--border)}
    .pill{border:1px solid var(--border);background:var(--chip);color:var(--chip-ink);padding:4px 8px;border-radius:999px}
    .warn{color:var(--warning);font-weight:600}
  </style>
  <!-- Libraries from CDN (works on GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/layout-base@2.0.1/layout-base.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cose-base@2.2.0/cose-base.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose@2.2.0/cytoscape-fcose.min.js"></script>
</head>
<body>
  <header>
    <h1>Graf Relasi Akun</h1>
    <span class="badge">Sumber: <code>data/all.csv</code></span>
    <div class="toolbar" style="margin-left:auto">
      <div class="group">
        <label for="search">Cari akun</label>
        <input id="search" type="text" placeholder="contoh: tvri, tvrisport" />
        <button id="btnSearch">Cari</button>
        <button id="btnClear">Bersihkan</button>
      </div>
      <div class="group">
        <label for="minWeight">Min interaksi</label>
        <input id="minWeight" type="range" min="1" max="10" step="1" value="1" />
        <span id="minWeightVal" class="pill">≥ 1</span>
      </div>
      <div class="group">
        <button id="btnFit">Fit</button>
        <button id="btnPng">Unduh PNG</button>
        <button id="btnReload">Muat Ulang</button>
      </div>
    </div>
  </header>

  <div id="status">Menunggu data…</div>
  <div id="cy"></div>
  <div class="legend">
    <span class="pill">Node = <strong>akun</strong> (user_screen_name)</span>
    <span class="pill">Edge berarah <strong>anak → induk</strong> (reply/RT menuju akun pemilik parent_tweet_id)</span>
    <span class="pill">Ketebalan edge = frekuensi interaksi</span>
    <span class="pill">Jika user induk tak ditemukan di data, label = <em>parent_tweet_id</em></span>
  </div>

  <script>
  // ======= UTIL =======
  const setStatus = (msg) => { document.getElementById('status').textContent = msg }

  // Normalize label (screen name) as node id key
  const norm = (s) => (s||'').toString().trim();

  // Global refs
  let cy;                // cytoscape instance
  let allElements = [];  // full elements (nodes+edges) before filtering
  let pairWeights = new Map(); // pair key -> weight

  async function loadCSV(defaultPath = 'data/all.csv'){
    setStatus(`Memuat ${defaultPath} …`);
    const res = await fetch(defaultPath, { cache: 'no-store' });
    if(!res.ok){
      setStatus(`Gagal memuat ${defaultPath}: ${res.status} ${res.statusText}. Pastikan file tersedia & domain sama (GitHub Pages OK).`);
      return null;
    }
    const text = await res.text();
    return new Promise((resolve)=>{
      Papa.parse(text, {
        header:true, skipEmptyLines:true, dynamicTyping:false,
        complete: (out)=> resolve(out.data)
      })
    })
  }

  function buildGraph(rows){
    // Expected columns: tweet_id, parent_tweet_id, user_screen_name
    // 1) peta tweet_id -> user_screen_name
    const idToUser = new Map();
    for(const r of rows){
      const tid = norm(r.tweet_id);
      const uname = norm(r.user_screen_name);
      if(tid) idToUser.set(tid, uname || tid);
    }

    // 2) hitung bobot interaksi antar akun (anak -> induk)
    pairWeights.clear();
    const seenUsers = new Set();

    for(const r of rows){
      const childUser = norm(r.user_screen_name) || norm(r.user_name) || 'unknown';
      const parentId = norm(r.parent_tweet_id);
      if(!parentId) continue; // hanya yang punya parent
      const parentUser = idToUser.get(parentId) || parentId; // fallback id jika tidak ditemukan

      const a = childUser; const b = parentUser;
      if(!a || !b) continue;
      seenUsers.add(a); seenUsers.add(b);

      const key = `${a}→${b}`;
      pairWeights.set(key, (pairWeights.get(key)||0) + 1);
    }

    // 3) bangun elemen Cytoscape
    const nodes = Array.from(seenUsers).map(u => ({ data:{ id:u, label:u } }));

    const edges = Array.from(pairWeights.entries()).map(([key, w])=>{
      const [a,b] = key.split('→');
      return { data:{ id:`${a}__${b}`, source:a, target:b, weight:w } };
    });

    allElements = [...nodes, ...edges];
  }

  function renderGraph(){
    // Destroy if exists
    if(cy){ cy.destroy(); cy = null }

    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: allElements,
      layout: { name:'fcose', animate:false, randomize:true, quality:'default', nodeSeparation: 75 },
      wheelSensitivity: 0.2,
      style: [
        { selector:'node', style:{
            'background-color':'#93c5fd',
            'label':'data(label)',
            'font-size': 10,
            'text-valign':'center',
            'text-halign':'center',
            'text-wrap':'wrap',
            'text-max-width': 120,
            'color':'#0f172a',
            'border-color':'#1d4ed8',
            'border-width':1,
            'width': 'mapData(degree, 0, 30, 10, 40)',
            'height':'mapData(degree, 0, 30, 10, 40)'
        }},
        { selector:'edge', style:{
            'width': 'mapData(weight, 1, 10, 1, 8)',
            'line-color':'#64748b',
            'curve-style':'bezier',
            'target-arrow-shape':'triangle',
            'target-arrow-color':'#64748b',
            'arrow-scale':1.2,
            'opacity':0.8
        }},
        { selector:'.highlight', style:{ 'background-color':'#22c55e', 'border-color':'#16a34a', 'border-width':2 }},
        { selector:'.dim', style:{ 'opacity':0.15 }},
      ]
    });

    cy.ready(() => setStatus(`Graf siap — ${cy.nodes().length} akun, ${cy.edges().length} relasi.`));
    cy.on('tap', 'node', (evt)=> focusNeighborhood(evt.target));
  }

  function focusNeighborhood(node){
    const neighborhood = node.closedNeighborhood();
    cy.elements().addClass('dim');
    neighborhood.removeClass('dim');
    neighborhood.addClass('highlight');
    cy.fit(neighborhood, 80);
  }

  function clearHighlights(){
    if(!cy) return;
    cy.elements().removeClass('dim');
    cy.elements().removeClass('highlight');
    cy.fit(cy.elements(), 60);
  }

  function applyMinWeightFilter(minW){
    if(!cy) return;
    // Show all first
    cy.edges().style('display','element');
    // Hide edges below threshold
    cy.edges().forEach(e=>{ if((e.data('weight')||0) < minW) e.style('display','none'); });
    // Hide isolated nodes
    cy.nodes().forEach(n=>{
      const visibleDeg = n.connectedEdges().filter(e=>e.style('display') !== 'none').length;
      n.style('display', visibleDeg>0 ? 'element' : 'none');
    });
    setStatus(`Filter diterapkan (≥ ${minW}) — ${cy.nodes(':visible').length} akun, ${cy.edges(':visible').length} relasi.`)
  }

  // ======= UI Wiring =======
  document.getElementById('btnSearch').addEventListener('click', ()=>{
    const q = norm(document.getElementById('search').value).toLowerCase();
    if(!q || !cy){ clearHighlights(); return; }
    const hit = cy.nodes().filter(n=> n.id().toLowerCase().includes(q) || (n.data('label')||'').toLowerCase().includes(q) );
    if(hit.length){ focusNeighborhood(hit[0]) } else { setStatus(`Akun "${q}" tidak ditemukan`) }
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('search').value=''; clearHighlights(); });
  document.getElementById('btnFit').addEventListener('click', ()=> cy && cy.fit(cy.elements(), 60));
  document.getElementById('btnPng').addEventListener('click', ()=>{
    if(!cy) return;
    const png = cy.png({ full:true, maxWidth:4096, maxHeight:4096, scale:2 });
    const a = document.createElement('a'); a.href = png; a.download = 'graf-relasi-akun.png'; a.click();
  });
  document.getElementById('btnReload').addEventListener('click', init);

  const range = document.getElementById('minWeight');
  const rangeVal = document.getElementById('minWeightVal');
  range.addEventListener('input', ()=>{ rangeVal.textContent = `≥ ${range.value}`; applyMinWeightFilter(parseInt(range.value,10)); });

  // ======= INIT =======
  async function init(){
    setStatus('Memuat & memproses data…');
    try{
      const rows = await loadCSV('data/all.csv');
      if(!rows){ return }
      // Validasi kolom minimal
      const required = ['tweet_id','parent_tweet_id','user_screen_name'];
      const has = required.every(k => Object.prototype.hasOwnProperty.call(rows[0]||{}, k));
      if(!has){
        setStatus(`Kolom wajib tidak lengkap. Pastikan CSV memiliki: ${required.join(', ')}`);
        return;
      }
      buildGraph(rows);
      renderGraph();
      applyMinWeightFilter(parseInt(range.value,10));
    }catch(e){
      console.error(e);
      setStatus('Terjadi kesalahan saat memuat atau memproses data. Lihat konsol untuk detailnya.');
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
