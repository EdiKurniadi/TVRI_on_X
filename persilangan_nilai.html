<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Persilangan Nilai</title>
  <!-- Resource asli halaman -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- ====== Styles App Shell (namespaced) ====== -->
  <style>
    :root{
      --sb-bg:#ffffff; --sb-border:#e2e8f0; --sb-ink:#0f172a; --sb-muted:#64748b;
      --sb-accent:#2563eb; --sb-accent-ink:#ffffff; --sb-shadow:0 1px 2px rgba(15,23,42,.06);
    }
    /* ===== App Shell ===== */
    .app-shell{display:grid;grid-template-columns:280px 1fr;min-height:100dvh;background:#f8fafc;color:var(--sb-ink)}
    .app-shell.collapsed{grid-template-columns:100px 1fr}
    .app-sidebar{position:sticky;top:0;height:100dvh;padding:12px}
    .sb-card{height:100%;background:var(--sb-bg);border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);display:flex;flex-direction:column}
    .sb-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--sb-border)}
    .sb-brand{display:flex;align-items:center;gap:10px}
    .sb-logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    .sb-title{font-weight:800}
    .sb-toggle{cursor:pointer;border:1px solid var(--sb-border);background:#fff;border-radius:10px;padding:8px}
    .sb-nav{padding:12px;display:grid;gap:8px;overflow:auto}
    .sb-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--sb-border);border-radius:12px;background:#fff;color:var(--sb-ink);text-decoration:none;font-weight:600}
    .sb-link:hover{border-color:#cbd5e1}
    .sb-link.active{background:var(--sb-accent);border-color:transparent;color:var(--sb-accent-ink)}
    .sb-ico{width:22px;height:22px;display:inline-grid;place-items:center}
    .sb-ico svg{width:20px;height:20px}
    .sb-label{white-space:nowrap}
    .sb-help{margin-top:auto;padding:12px;border-top:1px dashed var(--sb-border);font-size:13px;color:var(--sb-muted)}
    /* Collapsed: sembunyikan label, center ikon */
    .app-shell.collapsed .sb-title,.app-shell.collapsed .sb-label,.app-shell.collapsed .sb-help{display:none}
    .app-shell.collapsed .sb-head{justify-content:center}
    .app-main{padding:20px}
    /* Optional: konten kartu di halaman */
    .app-card{background:#fff;border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);padding:16px}
  </style>

  <!-- ====== Styles asli halaman (dipertahankan) ====== -->
  <style>
    :root{
      --bg:#f8fafc; /* slate-50 */
      --card:#ffffff;
      --ink:#0f172a; /* slate-900 */
      --muted:#475569; /* slate-600 */
      --accent:#2563eb; /* blue-600 */
      --accent-2:#dbeafe; /* blue-100 */
      --border:#e2e8f0; /* slate-200 */
      --danger:#dc2626; /* red-600 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    header.page-sticky{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(248,250,252,.7));backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:20px;margin:0 0 6px 0}
    p.sub{margin:0;color:var(--muted)}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:16px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;font-weight:600;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink)}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}

    .table-wrap{margin-top:16px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:700px;background:#fff}
    thead th{position:sticky;top:0;background:var(--accent-2);text-align:center}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;vertical-align:middle}
    /* wrap header text and prevent overflow */
    th{white-space:normal;word-break:break-word;max-width:220px}
    th:first-child, td:first-child{position:sticky;left:0;background:#fff}
    tbody tr:nth-child(even) td{background:#fafbff}
    tfoot td{font-weight:700;background:#f3f6ff}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px;color:var(--muted)}
    .statbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .empty{padding:30px;text-align:center;color:var(--muted)}

    .dl-row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-top:8px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:100%;max-width:520px;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .modal header{position:static;background:#fff;border-bottom:1px solid var(--border)}
    .modal .content{padding:16px;display:grid;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label.title{font-weight:700}
    select,input[type="file"],input[type="checkbox"]+span{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .check{display:inline-flex;align-items:center;gap:8px}
  </style>
</head>
<body>
  <!-- ===== APP SHELL (tempel di awal <body>) ===== -->
  <div id="APP" class="app-shell">
    <!-- ===== SIDEBAR ===== -->
    <aside class="app-sidebar" aria-label="Navigasi Layanan">
      <div class="sb-card">
        <div class="sb-head">
          <div class="sb-brand">
            <div class="sb-title">TVRI on <span class="x">ùïè</span></div>
          </div>
          <button id="sbToggle" class="sb-toggle" title="Sembunyikan/Expand sidebar" aria-expanded="true">‚ü®‚ü©</button>
        </div>
        <nav class="sb-nav">
        <a class="sb-link" href="index.html" title="Data Viewer"><span class="sb-ico">{#icon-doc#}</span><span class="sb-label">Data Viewer</span></a>
        <a class="sb-link" href="distribusi_nilai.html" title="Distribusi Nilai"><span class="sb-ico">{#icon-chart#}</span><span class="sb-label">Distribusi Nilai</span></a>
        <a class="sb-link" href="persilangan_nilai.html" title="Persilangan Nilai"><span class="sb-ico">{#icon-grid#}</span><span class="sb-label">Persilangan Nilai</span></a>
        <a class="sb-link" href="timeline_distribusi.html" title="Analisis Timeline"><span class="sb-ico">{#icon-trend#}</span><span class="sb-label">Analisis Timeline</span></a>
       <!--  <a class="sb-link" href="laporan-ringkas.html" title="Laporan Ringkas"><span class="sb-ico">{#icon-doc#}</span><span class="sb-label">Laporan Ringkas</span></a>
        <a class="sb-link" href="pengaturan.html" title="Pengaturan"><span class="sb-ico">{#icon-cog#}</span><span class="sb-label">Pengaturan</span></a> -->
      </nav>
      </div>
    </aside>

    <!-- ===== KONTEN HALAMAN (pindahkan DOM asli ke sini) ===== -->
    <main class="app-main">
      <!-- ====== DOM ASLI HALAMAN: persilangan_nilai.html ====== -->
      <header class="page-sticky">
        <div class="container">
          <h1>Distribusi Persilangan Nilai</h1>
        </div>
      </header>

      <main class="container" style="display:grid;gap:16px">
        <section class="card">
          <div class="actions">
            <input id="file" type="file" accept=".csv,text/csv" />
            <span class="badge" id="fileInfo">Belum ada file</span>
            <button id="btnConfig" disabled>Konfigurasi</button>
            <button id="clear">Bersihkan</button>
          </div>
          <div class="statbar" id="stats"></div>
        </section>

        <section class="card">
          <div id="output" class="table-wrap">
            <div class="empty">Unggah CSV, lalu buka <b>Konfigurasi</b> untuk memilih kolom & pengaturan tampilan.</div>
          </div>
          <div class="dl-row">
            <span></span>
            <button id="downloadPng" disabled>Download PNG</button>
          </div>
        </section>
      </main>

      <!-- Modal Konfigurasi -->
      <div class="modal-backdrop" id="modalWrap" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
          <header>
            <div class="container" style="padding:12px 16px">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                <h2 id="modalTitle" style="margin:0;font-size:18px">Konfigurasi Tabel</h2>
                <button id="closeModal">Tutup</button>
              </div>
            </div>
          </header>
          <div class="content">
            <div class="field">
              <label for="colA" class="title">Kolom A (baris)</label>
              <select id="colA" disabled></select>
            </div>
            <div class="field">
              <label for="colB" class="title">Kolom B (kolom)</label>
              <select id="colB" disabled></select>
            </div>
            <div class="field">
              <label class="title">Tampilan</label>
              <div class="row">
                <label class="check"><input type="checkbox" id="toggleHeat" checked> Heatmap warna</label>
                <label class="check"><input type="checkbox" id="togglePctRow"> % per baris</label>
                <label class="check"><input type="checkbox" id="togglePctCol"> % per kolom</label>
              </div>
            </div>
            <div class="row" style="justify-content:flex-end;margin-top:6px">
              <button id="apply" class="primary">Terapkan</button>
            </div>
          </div>
        </div>
      </div>
      <!-- ====== /DOM ASLI ====== -->
    </main>
  </div>

  <!-- ====== Ikon SVG + Toggle + Auto-Active ====== -->
  <script>
    /* ====== Ikon SVG (inline, agar tampil saat collapse) ====== */
    const ICONS = {
      chart:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="7" rx="1"/><rect x="12" y="6" width="3" height="11" rx="1"/><rect x="17" y="12" width="3" height="5" rx="1"/></svg>`,
      grid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>`,
      trend:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 7-7"/><path d="M21 21H3"/></svg>`,
      cloud:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19a4.5 4.5 0 0 0 .5-9 6 6 0 0 0-11.3-1.8A4 4 0 0 0 7 19h10.5z"/></svg>`,
      doc:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8M8 17h6M8 9h3"/></svg>`,
      cog:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09c0 .66.39 1.25 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.47.47-.61 1.17-.33 1.78.24.52.73.86 1.29.86H21a2 2 0 1 1 0 4h-.09c-.66 0-1.25.39-1.51 1z"/></svg>`
    };

    // Ganti placeholder {#icon-...#} dengan SVG
    document.querySelectorAll('.sb-ico').forEach(el=>{
      const html = el.innerHTML;
      const key = /\{#icon-([a-z]+)#\}/.exec(html);
      if(key && ICONS[key[1]]) el.innerHTML = ICONS[key[1]]; else el.innerHTML = ICONS.grid;
    });

    // Collapse toggle + persistence
    const APP = document.getElementById('APP');
    const SB_TOGGLE = document.getElementById('sbToggle');
    function applySBState(){
      const collapsed = localStorage.getItem('sb-collapsed') === '1';
      APP.classList.toggle('collapsed', collapsed);
      SB_TOGGLE.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
    }
    SB_TOGGLE.addEventListener('click',()=>{
      const next = !(localStorage.getItem('sb-collapsed') === '1');
      localStorage.setItem('sb-collapsed', next ? '1' : '0');
      applySBState();
    });
    applySBState();

    // Auto-aktifkan link berdasarkan URL (fallback jika class="active" tidak diset manual)
    (function autoActive(){
      const path = location.pathname.split('/').pop();
      let matched = false;
      document.querySelectorAll('.sb-link').forEach(a=>{
        const href = a.getAttribute('href');
        if(!href) return;
        const fname = href.split('/').pop();
        if(fname && fname === path){ a.classList.add('active'); matched = true; }
      });
    })();
  </script>

  <!-- ====== Script asli halaman (dipertahankan) ====== -->
  <script>
  (function(){
    const el = sel => document.querySelector(sel);
    const fileInput = el('#file');
    const fileInfo = el('#fileInfo');
    const btnConfig = el('#btnConfig');
    const clearBtn = el('#clear');
    const output = el('#output');
    const stats = el('#stats');
    const downloadPngBtn = el('#downloadPng');

    // Modal elements
    const modalWrap = el('#modalWrap');
    const colA = el('#colA');
    const colB = el('#colB');
    const toggleHeat = el('#toggleHeat');
    const togglePctRow = el('#togglePctRow');
    const togglePctCol = el('#togglePctCol');
    const applyBtn = el('#apply');
    const closeModalBtn = el('#closeModal');

    let rawData = [];
    let headers = [];
    let last = null; // cache for rendering
    let chosenA = '';
    let chosenB = '';

    function resetUI(){
      headers = [];
      rawData = [];
      last = null;
      chosenA = chosenB = '';
      colA.innerHTML = '';
      colB.innerHTML = '';
      btnConfig.disabled = true; downloadPngBtn.disabled = true;
      output.innerHTML = '<div class="empty">Unggah CSV, lalu buka <b>Konfigurasi</b> untuk memilih kolom & pengaturan tampilan.</div>';
      stats.innerHTML = '';
      fileInfo.textContent = 'Belum ada file';
      hideModal();
    }

    clearBtn.addEventListener('click', resetUI);

    // Modal helpers
    function showModal(){ modalWrap.style.display = 'flex'; modalWrap.setAttribute('aria-hidden','false'); }
    function hideModal(){ modalWrap.style.display = 'none'; modalWrap.setAttribute('aria-hidden','true'); }
    btnConfig.addEventListener('click', showModal);
    closeModalBtn.addEventListener('click', hideModal);
    modalWrap.addEventListener('click', (e)=>{ if(e.target === modalWrap) hideModal(); });

    // File upload
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if(!f){ resetUI(); return; }
      fileInfo.textContent = `${f.name} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB`;

      Papa.parse(f, {
        header: true,
        skipEmptyLines: 'greedy',
        dynamicTyping: false,
        complete: (res) => {
          const data = res.data || [];
          const meta = res.meta || {};
          headers = meta.fields || (data.length ? Object.keys(data[0]) : []);
          rawData = data;
          if(!headers.length){
            output.innerHTML = '<div class="empty">Gagal membaca header CSV. Pastikan baris pertama berisi nama kolom.</div>';
            return;
          }
          const opts = ['<option value="" disabled selected>‚Äî pilih kolom ‚Äî</option>']
            .concat(headers.map(h => `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`));
          colA.innerHTML = opts.join('');
          colB.innerHTML = opts.join('');
          colA.disabled = false; colB.disabled = false; btnConfig.disabled = false;
          stats.innerHTML = `<span class="badge">Baris: ${data.length.toLocaleString('id-ID')}</span>`;
          showModal();
        },
        error: (err) => {
          output.innerHTML = `<div class="empty" style="color:var(--danger)">Error parsing: ${escapeHtml(err.message||String(err))}</div>`
        }
      });
    });

    // Apply configuration
    applyBtn.addEventListener('click', () => {
      const aKey = colA.value; const bKey = colB.value;
      if(!aKey || !bKey){
        alert('Pilih dua kolom terlebih dahulu.');
        return;
      }
      chosenA = aKey; chosenB = bKey;
      const res = computeCross(rawData, aKey, bKey);
      last = { ...res, aKey, bKey };
      renderTable();
      downloadPngBtn.disabled = false;
      const { rows, cols, grandTotal } = res;
      stats.innerHTML = `
        <span class="badge">Kolom A: ${escapeHtml(aKey)}</span>
        <span class="badge">Kolom B: ${escapeHtml(bKey)}</span>
        <span class="badge">Kategori A: ${rows.length}</span>
        <span class="badge">Kategori B: ${cols.length}</span>
        <span class="badge">Total hitung: ${grandTotal.toLocaleString('id-ID')}</span>
      `;
      hideModal();
    });

    // When toggles change, re-render if table exists
    [toggleHeat, togglePctRow, togglePctCol].forEach(cb=>{
      cb.addEventListener('change', () => { if(last) renderTable(); });
    });

    // Download PNG
    downloadPngBtn.addEventListener('click', async () => {
      const node = output; if(!node) return;
      const oldScroll = node.scrollLeft; node.scrollLeft = 0;
      const canvas = await html2canvas(node, {scale:2, backgroundColor:'#ffffff', useCORS:true});
      node.scrollLeft = oldScroll;
      canvas.toBlob((blob)=>{
        if(!blob) return;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const nmA = chosenA ? slug(chosenA) : 'A';
        const nmB = chosenB ? slug(chosenB) : 'B';
        a.download = `persilangan_${nmA}_x_${nmB}.png`;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
      }, 'image/png');
    });

    function computeCross(data, aKey, bKey){
      const norm = (s) => {
        if(s==null) return '';
        let v = String(s).trim().toLowerCase();
        return v;
      };

      const parseAuto = (s) => {
        if(s==null) return [''];
        const raw = String(s).trim();
        if(raw === '') return [''];
        if( (raw.startsWith('[') && raw.endsWith(']')) || (raw.startsWith('{') && raw.endsWith('}')) ){
          try{ const arr = JSON.parse(raw); if(Array.isArray(arr)) return arr.map(x=>norm(x)).filter(validVal); }catch(e){}
        }
        if(/[;,|]/.test(raw)){
          return raw.split(/\s*[;,|]\s*/).map(x=>norm(x)).filter(validVal);
        }
        return [norm(raw)].filter(validVal);
      };

      const validVal = (v) => v!=='' && v!=='null' && v!=='undefined';

      const table = new Map();
      const rowSet = new Set();
      const colSet = new Set();
      let grandTotal = 0;

      for(const row of data){
        const aVals = [...new Set(parseAuto(row[aKey]))];
        const bVals = [...new Set(parseAuto(row[bKey]))];
        if(!aVals.length || !bVals.length) continue;
        for(const a of aVals){
          rowSet.add(a);
          for(const b of bVals){
            colSet.add(b);
            if(!table.has(a)) table.set(a, new Map());
            const inner = table.get(a);
            inner.set(b, (inner.get(b)||0)+1);
            grandTotal++;
          }
        }
      }

      const rows = [...rowSet].sort(localeSmart);
      const cols = [...colSet].sort(localeSmart);

      const totals = { row:{}, col:{} };
      let globalMax = 0;
      for(const r of rows){
        let rsum = 0;
        if(!table.has(r)) table.set(r, new Map());
        const inner = table.get(r);
        for(const c of cols){
          const v = inner.get(c)||0; rsum += v; globalMax = Math.max(globalMax, v); inner.set(c, v);
          totals.col[c] = (totals.col[c]||0)+v;
        }
        totals.row[r] = rsum;
      }

      return { table, rows, cols, totals, grandTotal, globalMax };
    }

    function renderTable(){
      const { table, rows, cols, totals, aKey, bKey, grandTotal, globalMax } = last || {};
      if(!rows || !cols || !rows.length || !cols.length){
        output.innerHTML = '<div class="empty">Tidak ada kategori yang terdeteksi. Pastikan kolom berisi nilai.</div>';
        return;
      }

      let html = '<table><thead><tr>';
      html += `<th>${escapeHtml(aKey)} \\ ${escapeHtml(bKey)}</th>`;
      for(const c of cols){ html += `<th>${escapeHtml(String(c))}</th>`; }
      html += '<th>Total Baris</th>';
      html += '</tr></thead><tbody>';

      for(const r of rows){
        html += `<tr><th>${escapeHtml(String(r))}</th>`;
        const inner = table.get(r) || new Map();
        const rsum = totals.row[r] || 0;
        for(const c of cols){
          const v = inner.get(c) || 0;
          const colTot = totals.col[c] || 1;
          const pctRow = rsum ? (v/rsum*100) : 0;
          const pctCol = colTot ? (v/colTot*100) : 0;
          const bg = el('#toggleHeat').checked ? heatColor(v, globalMax) : '';
          const cell = `
            <div class="cell" style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
              <div class="count" style="font-variant-numeric:tabular-nums">${v.toLocaleString('id-ID')}</div>
              ${el('#togglePctRow').checked ? `<div class="pct" style="font-size:11px;color:#334155;opacity:.85"><b>R</b>: ${pctRow.toFixed(1)}%</div>`:''}
              ${el('#togglePctCol').checked ? `<div class="pct" style="font-size:11px;color:#334155;opacity:.85"><b>K</b>: ${pctCol.toFixed(1)}%</div>`:''}
            </div>`;
          html += `<td style="text-align:right;${bg}">${cell}</td>`;
        }
        html += `<td style="text-align:right;font-weight:600">${rsum.toLocaleString('id-ID')}</td>`;
        html += '</tr>';
      }

      html += '</tbody><tfoot>';
      html += '<tr><td style="font-weight:700">Total Kolom</td>';
      for(const c of cols){ html += `<td style="text-align:right;font-weight:700">${(totals.col[c]||0).toLocaleString('id-ID')}</td>`; }
      html += `<td style="text-align:right;font-weight:700">${grandTotal.toLocaleString('id-ID')}</td>`;
      html += '</tr></tfoot></table>';

      output.innerHTML = html;
    }

    // Heat color helper: scale 0..globalMax to light‚Üídeep blue
    function heatColor(v, max){
      if(max <= 0) return '';
      const t = v/max; // 0..1
      const light = 98 - (38 * t); // L from 98 to 60
      const sat = 90; // %
      return `background: hsl(214 ${sat}% ${light}%);`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",
        ">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }
    function slug(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }
    function localeSmart(a,b){
      return String(a).localeCompare(String(b), 'id', { numeric:true, sensitivity:'base' });
    }
  })();
  </script>
</body>
</html>
